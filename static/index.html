<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rust Parser Playground</title>

    <!-- CodeMirror æ ¸å¿ƒ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/rust/rust.min.js"></script>

    <!-- VSCode Light/Dark ä¸»é¢˜ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/vscode-light.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/vscode-dark.min.css" />

    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.2/d3.min.js"></script>

    <style>
        /* æµ…/æ·±è‰²ä¸»é¢˜å˜é‡ */
        :root[data-theme="light"] {
            --bg-main: #ffffff;
            --fg-main: #000000;
            --border: #d4d4d4;
            --header-bg: #f3f3f3;
            --error-bg: #fdd;
            --error-fg: #a00;
            --editor-bg: #ffffff;
            /* ç¼–è¾‘å™¨èƒŒæ™¯-æµ… */
            --gutter-bg: #f3f3f3;
            /* è¡Œå·èƒŒæ™¯-æµ… */
            --gutter-fg: #5a5a5a;
            /* è¡Œå·æ–‡å­—-æµ… */
            --node-color: #0064c8;
            --node-text: #000000;
            --link-color: #555555;
        }

        :root[data-theme="dark"] {
            --bg-main: #1e1e1e;
            --fg-main: #ffffff;
            --border: #3c3c3c;
            --header-bg: #2d2d2d;
            --error-bg: #5a1e1e;
            --error-fg: #f88;
            --editor-bg: #252526;
            /* ç¼–è¾‘å™¨èƒŒæ™¯-æ·± */
            --gutter-bg: #2d2d2d;
            /* è¡Œå·èƒŒæ™¯-æ·± */
            --gutter-fg: #858585;
            /* è¡Œå·æ–‡å­—-æ·± */
            --node-color: #4fc3f7;
            --node-text: #e0e0e0;
            --link-color: #888888;
        }

        /* å…¨å±€å¸ƒå±€ */
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background: var(--bg-main);
            color: var(--fg-main);
            font-family: sans-serif;
        }

        /* å·¦ä¾§ç¼–è¾‘å™¨åŒºåŸŸ */
        #editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }

        #editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border);
        }

        .CodeMirror {
            flex: 1;
            height: auto;
            background: var(--editor-bg) !important;
            color: var(--fg-main) !important;
            /* è¦†ç›–é»˜è®¤èƒŒæ™¯ */
            /* **å»æ‰ color: var(--editor-fg)**ï¼Œè®©ä¸»é¢˜è‡ªè¡Œä¸Šè‰² */
        }

        /* è¦†ç›–è¡Œå·åŒºæ ·å¼ */
        .CodeMirror-gutters {
            background: var(--gutter-bg) !important;
            border-right: 1px solid var(--border) !important;
        }

        .CodeMirror-linenumber {
            color: var(--gutter-fg) !important;
        }

        /* å³ä¾§å¯è§†åŒ–åŒºåŸŸ */
        #visual-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #visual-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border);
        }

        #visual-header button {
            width: 24px;
            height: 24px;
            line-height: 20px;
            border: 1px solid var(--border);
            background: var(--bg-main);
            color: var(--fg-main);
            cursor: pointer;
        }

        #error {
            flex: 0 0 auto;
            padding: 8px;
            background: var(--error-bg);
            color: var(--error-fg);
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
            border-bottom: 1px solid var(--border);
        }

        #tree {
            flex: 1;
            width: 100%;
            height: 100%;
        }

        #quadruples {
            flex: 0 0 auto;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            margin: 0;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border);
            font-family: monospace;
            white-space: pre;
            display: none;  /* é»˜è®¤éšè— */
        }

        /* é”™è¯¯æ³¢æµªçº¿ */
        .cm-error-underline {
            text-decoration: red wavy underline;
        }

        /* å…‰æ ‡é¢œè‰² */
        .CodeMirror-cursor {
            border-left: 1px solid var(--fg-main) !important;
        }

        .cm-fat-cursor .CodeMirror-cursor {
            background-color: var(--fg-main) !important;
        }

        /* è‡ªå®šä¹‰ä¸Šè‰² */
        /* ==== VSCode Dark+ Token Colors ==== */

        /* 1. å…³é”®å­— */
        .token-LET,
        .token-FN,
        .token-FOR,
        .token-IN,
        .token-WHILE,
        .token-IF,
        .token-ELSE,
        .token-RETURN,
        .token-MUT,
        .token-LOOP,
        .token-BREAK,
        .token-CONTINUE {
            color: #569CD6;
            /* è“è‰² */
            font-weight: bold;
            /* åŠ ç²— */
        }

        /* 2. æ ‡è¯†ç¬¦ï¼ˆå‡½æ•°åã€å˜é‡åç­‰ï¼‰ */
        .token-IDENTIFIER {
            color: #eebb2f;
            /* æµ…é’è‰² */
        }

        /* 3. å®æ ‡è¯†ç¬¦ */
        .token-MACRO_IDENTIFIER {
            color: #C586C0;
            /* å“çº¢ */
        }

        /* 4. ç±»å‹å */
        .token-I32 {
            color: #4EC9B0;
            /* é’ç»¿è‰² */
        }

        /* 5. æ•°å­—å­—é¢é‡ */
        .token-INTEGER_CONSTANT,
        .token-FLOATING_POINT_CONSTANT {
            color: #B5CEA8;
            /* æµ…ç»¿è‰² */
        }

        /* 6. å­—ç¬¦ / å­—ç¬¦ä¸² */
        .token-CHAR_CONSTANT,
        .token-STRING_CONSTANT {
            color: #CE9178;
            /* æ©™è‰² */
        }

        /* 7. æ³¨é‡Š */
        .token-S_COMMENT,
        .token-LM_COMMENT,
        .token-RM_COMMENT {
            color: #6A9955;
            /* æ·±ç»¿ */
            font-style: italic;
        }

        /* 8. æ“ä½œç¬¦ & æ ‡ç‚¹ */
        .token-ASSIGN,
        .token-PLUS,
        .token-MINUS,
        .token-MULT,
        .token-DIV,
        .token-EQ,
        .token-GT,
        .token-GE,
        .token-LT,
        .token-LE,
        .token-NEQ,
        .token-LPAREN,
        .token-RPAREN,
        .token-LBRACE,
        .token-RBRACE,
        .token-LBRACK,
        .token-RBRACK,
        .token-SEMICOLON,
        .token-COLON,
        .token-COMMA,
        .token-ARROW,
        .token-DOT,
        .token-DOTDOT,
        .token-AMP {
            color: #e466f5;
            /* é»˜è®¤ç°ç™½ */
        }

        /* 9. ç‰¹æ®Šï¼šæœªçŸ¥ / é”™è¯¯ */
        .token-UNKNOWN {
            background-color: rgba(244, 67, 54, 0.2) !important;
            color: #F44747 !important;
            text-decoration: wavy underline;
        }

        /* 10. æ–‡ä»¶ç»“æŸç¬¦ï¼ˆä¸æ˜¾ç¤ºï¼‰ */
        .token-EOF {
            color: transparent;
        }


        /* â€¦â€¦æ ¹æ®éœ€è¦ç»§ç»­æ·»åŠ â€¦â€¦ */
    </style>
</head>

<body>
    <!-- ç¼–è¾‘å™¨åŒº -->
    <div id="editor-container">
        <div id="editor-header">
            <span>Editor</span>
            <button id="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
        </div>
        <textarea id="editor"></textarea>
    </div>

    <!-- è¯­æ³•æ ‘å¯è§†åŒ–åŒº -->
    <div id="visual-container">
        <div id="visual-header">
            <span>Parser Output</span>
            <div>
                <button id="zoom-in" title="æ”¾å¤§">ï¼‹</button>
                <button id="zoom-out" title="ç¼©å°">ï¼</button>
            </div>
        </div>
        <div id="error"></div>
        <svg id="tree"></svg>
    </div>

    <div id="visual-container">
        <div id="visual-header">
            <span>Parser Output</span>
            <div>
                <button id="zoom-in" title="æ”¾å¤§">ï¼‹</button>
                <button id="zoom-out" title="ç¼©å°">ï¼</button>
            </div>
        </div>
        <div id="error"></div>
        <pre id="quadruples"></pre>  <!-- æ–°å¢å››å…ƒå¼å±•ç¤ºåŒºåŸŸ -->
        <svg id="tree"></svg>
    </div>

    <script>
        const root = document.documentElement;
        const themeToggle = document.getElementById('theme-toggle');

        function switchTheme() {
            const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            root.setAttribute('data-theme', next);
            themeToggle.textContent = next === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
            editor.setOption('theme', next === 'light' ? 'vscode-light' : 'vscode-dark');
            // æ›´æ–° D3 æ ‘çš„é¢œè‰²
            d3.selectAll('circle').attr('fill', 'var(--node-color)');
            d3.selectAll('text.node-label').attr('fill', 'var(--node-text)');
            d3.selectAll('.link').attr('stroke', 'var(--link-color)');
        }
        themeToggle.addEventListener('click', switchTheme);

        // åˆå§‹åŒ– CodeMirror
        const initTheme = root.getAttribute('data-theme') === 'light' ? 'vscode-light' : 'vscode-dark';
        const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            mode: 'rust',
            lineNumbers: true,
            theme: initTheme
        });

        let errorMarks = [];
        function highlightErrors(error, success) {
            console.log(error)
            console.log("highlightErrors")
            errorMarks.forEach(m => m.clear());
            errorMarks = [];
            if (!success) {
                const from = { line: error.tok.loc.row - 1, ch: error.tok.loc.col - 1 };
                const to = { line: error.tok.loc.row - 1, ch: error.tok.loc.col - 1 + error.tok.content.length };
                errorMarks.push(editor.getDoc().markText(from, to, { className: 'cm-error-underline' }));

            }
        }

        let tokenMarks = [];

        // æ¸…é™¤æ‰€æœ‰æ ‡è®°
        function clearAllMarks() {
            tokenMarks.forEach(m => m.clear());
            tokenMarks = [];
            errorMarks.forEach(m => m.clear());
        }

        // ç”¨ä¸åŒ class ç»™æ¯ä¸ª token ä¸Šè‰²
        function markTokens(tokens) {
            // console.log("mark")
            tokens.forEach(tok => {
                const from = { line: tok.loc.row - 1, ch: tok.loc.col - 1 };
                const to = { line: tok.loc.row - 1, ch: tok.loc.col - 1 + tok.content.length };
                // console.log(tok.prop)
                tokenMarks.push(
                    editor.getDoc().markText(from, to, {
                        className: 'token-' + tok.prop
                    })
                );
            });
        }

        // ä¿®æ”¹ parseCode æµç¨‹
        async function parseCode() {
            const res = await fetch('/api/parse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: editor.getValue() })
            });
            const data = await res.json();

            clearAllMarks();   // å…ˆæ¸…ç†æ—§æ ‡è®°

            if (data.error) {
                document.getElementById('error').textContent =
                    `Error: ${data.error.content} (line ${data.error.loc.row}, col ${data.error.loc.col})`;
                document.getElementById('error').style.display = 'block';
                g.selectAll('*').remove();
                markTokens(data.tokens);
                highlightErrors(data.error, false);
            } else {
                document.getElementById('error').style.display = 'none';
                g.selectAll('*').remove();
                // åˆ†ææˆåŠŸæ—¶ç»™æ‰€æœ‰ token ä¸Šè‰²
                markTokens(data.tokens);
                renderTree(data.tree);
            }
        }

        function debounce(fn, delay = 500) {
            let t; return (...args) => {
                clearTimeout(t); t = setTimeout(() => fn(...args), delay);
            };
        }

        // D3 ç¼©æ”¾ & å¸ƒå±€
        const svg = d3.select('#tree');
        const g = svg.append('g').attr('transform', 'translate(40,40)');
        const zoom = d3.zoom().on('zoom', e => g.attr('transform', e.transform));
        svg.call(zoom);
        document.getElementById('zoom-in').onclick = () => svg.transition().call(zoom.scaleBy, 1.2);
        document.getElementById('zoom-out').onclick = () => svg.transition().call(zoom.scaleBy, 0.8);

        const debouncedParse = debounce(parseCode, 500);
        editor.on('change', debouncedParse);

        // æ¸²æŸ“è¯­æ³•æ ‘
        function renderTree(treeData) {
            g.selectAll('*').remove();

            const w = +svg.node().clientWidth;
            const h = +svg.node().clientHeight;

            const rootN = d3.hierarchy(treeData, d => d.children);


            d3.tree().nodeSize([60, 180])(rootN);


            g.selectAll('.link')
                .data(rootN.links())
                .join('path')
                .attr('class', 'link')
                .attr('fill', 'none')
                .attr('stroke', 'var(--link-color)')
                .attr('stroke-width', 1.5)
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x));

            const node = g.selectAll('.node')
                .data(rootN.descendants())
                .join('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.y},${d.x})`)
                .on('mouseover', (_, d) => {
                    const subs = d.descendants();
                    g.selectAll('circle').attr('fill', n => subs.includes(n) ? '#f00' : 'var(--node-color)');
                    g.selectAll('.link').attr('stroke',
                        l => subs.includes(l.source) && subs.includes(l.target) ? '#f00' : 'var(--link-color)');
                })
                .on('mouseout', () => {
                    g.selectAll('circle').attr('fill', 'var(--node-color)');
                    g.selectAll('.link').attr('stroke', 'var(--link-color)');
                });


            node.append('circle')
                .attr('r', 8)
                .attr('fill', 'var(--node-color)');


            node.append('text')
                .attr('class', 'node-label')
                .attr('dy', 4)
                .attr('x', 0)
                .style('text-anchor', 'middle')
                .attr('fill', 'var(--node-text)')
                .text(d => d.data.root)
                .style('font-size', '13px')
                .style('pointer-events', 'none');  // é˜²æ­¢ hover æ—¶è¢«è¯¯è§¦
        }

        async function parseCode() {
            const res = await fetch('/api/parse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: editor.getValue() })
            });
            const data = await res.json();

            clearAllMarks();   // æ¸…ç†æ—§æ ‡è®°

            if (data.error) {
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.getElementById('error').textContent =
                    `Error: ${data.error.content} (line ${data.error.loc.row}, col ${data.error.loc.col})`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('quadruples').style.display = 'none';  // éšè—å››å…ƒå¼
                g.selectAll('*').remove();
                markTokens(data.tokens);
                highlightErrors(data.error, false);
            } else {
                // æ˜¾ç¤ºè¯­æ³•æ ‘å’Œå››å…ƒå¼
                document.getElementById('error').style.display = 'none';
                g.selectAll('*').remove();
                markTokens(data.tokens);
                renderTree(data.tree);

                // æ˜¾ç¤ºå››å…ƒå¼
                const quadruplesEl = document.getElementById('quadruples');
                if (data.quadruples && data.quadruples.length > 0) {
                    quadruplesEl.textContent = data.quadruples
                        .map((quad, i) => `${i.toString().padStart(3, '0')}: ${JSON.stringify(quad)}`)
                        .join('\n');
                    quadruplesEl.style.display = 'block';
                } else {
                    quadruplesEl.style.display = 'none';
                }
            }
        }


        // åˆæ¬¡æ¸²æŸ“
        parseCode();
    </script>
</body>

</html>